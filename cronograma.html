<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma Online - Meu Sert√£o Acess√≠vel</title>
    
    <!-- Importando a Biblioteca do Supabase via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --success: #10b981;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 20px; }
        
        /* Header */
        header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--primary); margin-bottom: 5px; font-size: 1.8rem; }
        p.subtitle { color: #666; margin-top: 0; }
        .status-indicator { font-size: 0.8rem; color: #666; margin-top: 5px; display: block; min-height: 20px;}
        .online { color: var(--success); font-weight: bold; }
        .offline { color: #ef4444; font-weight: bold; }

        /* Filtros */
        .filters { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 20px; -webkit-overflow-scrolling: touch; }
        .filter-btn { 
            background: white; border: 1px solid #ddd; padding: 8px 16px; border-radius: 20px; 
            cursor: pointer; white-space: nowrap; font-weight: bold; transition: 0.2s;
        }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Barra de Progresso Geral */
        .progress-container { background: #e5e7eb; border-radius: 10px; height: 20px; margin-bottom: 30px; overflow: hidden; position: relative; }
        .progress-bar { background: var(--success); height: 100%; width: 0%; transition: width 0.5s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; color: #333; }

        /* Semanas */
        .week-section { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .week-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .week-title { margin: 0; font-size: 1.2rem; color: var(--primary); }
        .week-date { font-size: 0.9rem; color: #888; }

        /* Tarefas */
        .task-item { display: flex; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid #eee; gap: 12px; }
        .task-item:last-child { border-bottom: none; }
        
        /* Checkbox customizado */
        .checkbox { 
            width: 22px; height: 22px; min-width: 22px; border: 2px solid #ccc; border-radius: 6px; 
            cursor: pointer; position: relative; margin-top: 2px; transition: all 0.2s;
        }
        .checkbox.checked { background: var(--success); border-color: var(--success); }
        .checkbox.checked::after { content: '‚úî'; color: white; position: absolute; top: -2px; left: 4px; font-size: 14px; }
        
        /* Estado de Carregando (Loading) */
        .checkbox.loading { border-color: #fbbf24; background: #fef3c7; cursor: wait; }
        
        .task-content { flex: 1; }
        .task-team { 
            display: inline-block; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; 
            background: #e0f2fe; color: #0369a1; font-weight: bold; margin-bottom: 4px; 
        }
        .task-desc { margin: 0; line-height: 1.4; }
        .task-desc.done { text-decoration: line-through; color: #9ca3af; }
        
        .is-delivery { border-left: 4px solid #f59e0b; padding-left: 10px; background: #fffbeb; padding: 10px; border-radius: 0 8px 8px 0; margin-top: 5px; }

        /* Copyright */
        .copyright { text-align: center; margin-top: 40px; font-size: 0.9rem; color: #9ca3af; border-top: 1px solid #e5e7eb; padding-top: 20px; font-weight: 500; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üìÖ Projeto Final</h1>
        <p class="subtitle">Meu Sert√£o Acess√≠vel | 18/11 a 10/12</p>
        <span id="connectionStatus" class="status-indicator">Conectando ao sistema...</span>
        
        <div class="progress-container">
            <div class="progress-bar" id="globalProgress"></div>
            <div class="progress-text" id="globalProgressText">0% Conclu√≠do</div>
        </div>
    </header>

    <div class="filters" id="filters">
        <button class="filter-btn active" onclick="filterTasks('all')">Todas</button>
        <button class="filter-btn" onclick="filterTasks('Equipe 1')">Eq. 1</button>
        <button class="filter-btn" onclick="filterTasks('Equipe 2')">Eq. 2</button>
        <button class="filter-btn" onclick="filterTasks('Equipe 3')">Eq. 3</button>
        <button class="filter-btn" onclick="filterTasks('Equipe 4')">Eq. 4</button>
        <button class="filter-btn" onclick="filterTasks('Equipe 5')">Eq. 5</button>
        <button class="filter-btn" onclick="filterTasks('Equipe 6')">Eq. 6</button>
    </div>

    <div id="app-content">
        <p style="text-align:center; color:#666;">Carregando tarefas...</p>
    </div>

    <div class="copyright">
        ¬© Wanderson Portela
    </div>
</div>

<script>
    // ==========================================
    // CONFIGURA√á√ÉO DO SUPABASE (J√Å INSERIDA)
    // ==========================================
    const SUPABASE_URL = 'https://ckeqxkfvfhpbtzdjqgwj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrZXF4a2Z2ZmhwYnR6ZGpxZ3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MTQxMDksImV4cCI6MjA3OTA5MDEwOX0.Bki5D_rwkc8mGKK7jMfP478rYTH78ier3dPY3bDIEAU';
    // ==========================================

    // Inicializando o Cliente Supabase
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    // Dados Estruturais (Tarefas do PDF)
    const structure = [
        {
            week: "SEMANA 1",
            date: "18 a 22 de Novembro",
            tasks: [
                { id: 101, team: "Todas", text: "18/11: Forma√ß√£o das equipes, defini√ß√£o de fun√ß√µes e planejamento inicial." },
                { id: 102, team: "Equipe 1", text: "In√≠cio da pesquisa de campo e identifica√ß√£o de barreiras de acessibilidade." },
                { id: 103, team: "Equipe 2", text: "Defini√ß√£o do tema central/p√∫blico-alvo e desenho das 3 vers√µes do roteiro." },
                { id: 104, team: "Equipe 3", text: "Cria√ß√£o do conceito da Condu√ß√£o Afetiva e t√©cnicas de acolhimento." },
                { id: 105, team: "Equipe 4", text: "Estrutura√ß√£o da Introdu√ß√£o do artigo e defini√ß√£o da metodologia escrita." },
                { id: 106, team: "Equipe 5", text: "Planejamento da apresenta√ß√£o l√∫dica e defini√ß√£o de pap√©is/recursos." },
                { id: 107, team: "Equipe 6", text: "Cria√ß√£o da identidade visual e prot√≥tipo digital inicial." },
                { id: 108, team: "ENTREGA", text: "Pr√©via do diagn√≥stico (Eq. 1)", isDelivery: true },
                { id: 109, team: "ENTREGA", text: "Tema + p√∫blico-alvo (Eq. 2)", isDelivery: true },
                { id: 110, team: "ENTREGA", text: "Esbo√ßo da Condu√ß√£o Afetiva (Eq. 3)", isDelivery: true }
            ]
        },
        {
            week: "SEMANA 2",
            date: "25 a 29 de Novembro",
            tasks: [
                { id: 201, team: "Equipe 1", text: "Finalizar pesquisas; relat√≥rio t√©cnico do destino." },
                { id: 202, team: "Equipe 2", text: "Finalizar 3 vers√µes do roteiro e tabelas de hor√°rios." },
                { id: 203, team: "Equipe 3", text: "Finalizar metodologia da Condu√ß√£o Afetiva e plano de condu√ß√£o." },
                { id: 204, team: "Equipe 4", text: "Reda√ß√£o do Referencial Te√≥rico e Metodologia." },
                { id: 205, team: "Equipe 5", text: "Ensaios iniciais, teste de trilha sonora e objetos." },
                { id: 206, team: "Equipe 6", text: "Prot√≥tipo digital beta, grava√ß√£o de entrevistas e QR Codes." },
                { id: 207, team: "ENTREGA", text: "Roteiro final (Eq. 2)", isDelivery: true },
                { id: 208, team: "ENTREGA", text: "Metodologia conclu√≠da (Eq. 3)", isDelivery: true },
                { id: 209, team: "ENTREGA", text: "60% do artigo (Eq. 4)", isDelivery: true },
                { id: 210, team: "ENTREGA", text: "Prot√≥tipo beta + grava√ß√µes (Eq. 6)", isDelivery: true }
            ]
        },
        {
            week: "SEMANA 3",
            date: "02 a 06 de Dezembro",
            tasks: [
                { id: 301, team: "Equipe 1", text: "Entrega final do diagn√≥stico; texto para artigo e v√≠deo." },
                { id: 302, team: "Equipe 2", text: "Revisar roteiro; criar mapa e infogr√°ficos." },
                { id: 303, team: "Equipe 3", text: "Ensaiar aplica√ß√£o pr√°tica da metodologia." },
                { id: 304, team: "Equipe 4", text: "Redigir Resultados e Discuss√£o; escrever Conclus√µes." },
                { id: 305, team: "Equipe 5", text: "Ensaio completo; testar degusta√ß√£o, trilha e objetos." },
                { id: 306, team: "Equipe 6", text: "Grava√ß√£o final; edi√ß√£o do document√°rio; finalizar QR Codes." },
                { id: 307, team: "ENTREGA", text: "Artigo 80% conclu√≠do (Eq. 4)", isDelivery: true },
                { id: 308, team: "ENTREGA", text: "Infogr√°fico + mapa (Eq. 2)", isDelivery: true },
                { id: 309, team: "ENTREGA", text: "Document√°rio em 70% (Eq. 6)", isDelivery: true }
            ]
        },
        {
            week: "RETA FINAL",
            date: "09 e 10 de Dezembro",
            tasks: [
                { id: 401, team: "Todas", text: "09/12 (Seg): Revis√£o final artigo, prot√≥tipo, ensaio geral e portf√≥lio." },
                { id: 402, team: "Todas", text: "10/12 (Ter): APRESENTA√á√ÉO FINAL (Experi√™ncia guiada, doc, prot√≥tipo)." },
                { id: 403, team: "ENTREGA", text: "Artigo cient√≠fico final", isDelivery: true },
                { id: 404, team: "ENTREGA", text: "Document√°rio Finalizado", isDelivery: true }
            ]
        }
    ];

    // Vari√°veis de Estado
    let dbState = {}; 
    let currentFilter = 'all';

    // 1. Carregar dados iniciais do Banco
    async function initApp() {
        try {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.innerHTML = 'Buscando dados...';

            // Busca todas as tarefas do banco
            const { data, error } = await sb.from('tasks').select('*');
            
            if (error) throw error;

            // Mapeia array para objeto { id: true/false }
            dbState = {};
            if(data) {
                data.forEach(row => {
                    dbState[row.id] = row.done;
                });
            }

            statusEl.innerHTML = '<span class="online">‚óè Sistema Online e Sincronizado</span>';
            renderApp(currentFilter);
            
            // Inicia escuta em tempo real
            setupRealtime();

        } catch (err) {
            console.error("Erro ao inicializar:", err);
            document.getElementById('connectionStatus').innerHTML = '<span class="offline">‚ö† Erro de conex√£o (Verifique internet)</span>';
        }
    }

    // 2. Configurar Realtime (Atualiza√ß√µes ao vivo)
    function setupRealtime() {
        sb.channel('public:tasks')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, payload => {
                console.log('Mudan√ßa detectada:', payload);
                const { id, done } = payload.new;
                
                // Atualiza estado local
                dbState[id] = done;
                
                // Atualiza visualmente apenas o checkbox espec√≠fico para n√£o recarregar tudo (opcional)
                // Mas por seguran√ßa, vamos re-renderizar a tela:
                renderApp(currentFilter);
            })
            .subscribe();
    }

    // 3. Renderizar a Interface
    function renderApp(filterTeam) {
        currentFilter = filterTeam;
        const container = document.getElementById('app-content');
        container.innerHTML = '';
        
        structure.forEach(week => {
            // Filtro de visualiza√ß√£o
            const visibleTasks = week.tasks.filter(t => {
                if (filterTeam === 'all') return true;
                if (t.team === 'Todas' || t.team === 'ENTREGA') return true;
                return t.team === filterTeam;
            });

            if (visibleTasks.length === 0) return;

            const weekCard = document.createElement('div');
            weekCard.className = 'week-section';
            
            let tasksHtml = '';
            visibleTasks.forEach(task => {
                const isChecked = dbState[task.id] ? 'checked' : '';
                const doneClass = dbState[task.id] ? 'done' : '';
                const deliveryClass = task.isDelivery ? 'is-delivery' : '';
                
                tasksHtml += `
                    <div class="task-item ${deliveryClass}">
                        <div id="chk-${task.id}" class="checkbox ${isChecked}" onclick="toggleTask(${task.id})"></div>
                        <div class="task-content">
                            <span class="task-team">${task.team}</span>
                            <p class="task-desc ${doneClass}">${task.text}</p>
                        </div>
                    </div>
                `;
            });

            weekCard.innerHTML = `
                <div class="week-header">
                    <h3 class="week-title">${week.week}</h3>
                    <span class="week-date">${week.date}</span>
                </div>
                ${tasksHtml}
            `;
            container.appendChild(weekCard);
        });

        updateFiltersUI();
        updateProgressBar();
    }

    // 4. A√ß√£o de Clicar (Enviar para o Supabase)
    async function toggleTask(id) {
        const chkElement = document.getElementById(`chk-${id}`);
        if(chkElement) chkElement.classList.add('loading'); // Feedback visual

        const newValue = !dbState[id];

        // Atualiza√ß√£o Otimista (atualiza na tela antes do banco responder)
        dbState[id] = newValue;
        renderApp(currentFilter);

        // Envia para o banco (Upsert: cria se n√£o existe, atualiza se existe)
        const { error } = await sb
            .from('tasks')
            .upsert({ id: id, done: newValue })
            .select();

        if (error) {
            alert('Erro ao salvar. Verifique sua conex√£o.');
            console.error(error);
            // Reverte erro
            dbState[id] = !newValue; 
            renderApp(currentFilter);
        }
    }

    function updateProgressBar() {
        let total = 0;
        let checked = 0;
        
        structure.forEach(week => {
            week.tasks.forEach(task => {
                total++;
                if (dbState[task.id]) checked++;
            });
        });

        const percent = total === 0 ? 0 : Math.round((checked / total) * 100);
        document.getElementById('globalProgress').style.width = percent + '%';
        document.getElementById('globalProgressText').innerText = percent + '% Conclu√≠do';
    }

    function filterTasks(team) {
        // Atualiza visual dos bot√µes
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        // Encontra o bot√£o clicado (via event n√£o √© ideal aqui, ent√£o buscamos pelo texto/onclick, 
        // mas para simplificar, vamos apenas re-renderizar o conte√∫do.
        // A atualiza√ß√£o visual dos bot√µes ser√° feita na updateFiltersUI se implementada complexamente,
        // mas aqui faremos simples via target no HTML onclick).
        
        renderApp(team);
    }

    // Helper para atualizar bot√µes de filtro visualmente
    window.onclick = function(e) {
        if (e.target.classList.contains('filter-btn')) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
        }
    }

    function updateFiltersUI() {
        // Mant√©m bot√µes funcionando
    }

    // Iniciar App
    initApp();

</script>
</body>
</html>